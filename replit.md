# ุจูุช ุงูููุชุจุฉ ุงูุชุนููููุฉ ุงูุฌุงูุนูุฉ

## ูุธุฑุฉ ุนุงูุฉ
ุจูุช ุชูููุฌุฑุงู ูุฅุฏุงุฑุฉ ููุชุจุฉ ุชุนููููุฉ ุฌุงูุนูุฉุ ูุชูุญ ูููุณุชุฎุฏููู ุชุตูุญ ุงูุฃูุณุงู ูุงููููุงุช ูุงููุณุงููุฉ ุจุงููุญุชูู.

## ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ
- **Python 3.11**
- **aiogram** - ุฅุทุงุฑ ุนูู ุจูุช ุชูููุฌุฑุงู
- **SQLAlchemy** - ORM ููุงุนุฏุฉ ุงูุจูุงูุงุช
- **asyncpg** - ูุดุบู PostgreSQL ุบูุฑ ูุชุฒุงูู
- **Alembic** - ุฅุฏุงุฑุฉ ุงููุฌุฑุงุช

## ูููู ุงููุดุฑูุน
```
bot/
โโโ core/                    # ุงูููุงุฉ ุงูุฃุณุงุณูุฉ
โ   โโโ config.py            # ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู
โ   โโโ constants.py         # ุงูุซูุงุจุช ุงููุฑูุฒูุฉ (LogMessages, ErrorMessages, I18nKeys, DefaultTexts, AuditActions, CallbackPrefixes)
โ   โโโ database.py          # ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ   โโโ logging_config.py    # ุฅุนุฏุงุฏุงุช ุงูุชุณุฌูู
โโโ handlers/                # ูุนุงูุฌุงุช ุงูุฑุณุงุฆู ูุงูุฃูุงูุฑ
โ   โโโ home.py              # ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฑุฆูุณูุฉ + ุฃุฒุฑุงุฑ ุงูุชููู + ููุญุฉ ุงูุชุญูู + deep linking
โ   โโโ sections.py          # ุนุฑุถ ุงูุฃูุณุงู + ุฅุฏุงุฑุฉ ุงูุฃูุณุงู (admin FSM)
โ   โโโ files.py             # ุฑูุน/ุนุฑุถ/ุญุฐู ุงููููุงุช + FSM + pagination + deep linking
โ   โโโ fallback.py          # ูุนุงูุฌ ุงูุฑุณุงุฆู ุงููุตูุฉ ุบูุฑ ุงููุนุฑููุฉ
โโโ middlewares/             # ุงููุณุทุงุก
โ   โโโ ban_check.py         # ูุญุต ุงูุญุธุฑ
โ   โโโ subscription_check.py # ูุญุต ุงูุงุดุชุฑุงู ุงูุฅุฌุจุงุฑู
โ   โโโ role_check.py        # ูุญุต ุงูุฏูุฑ ูุชุญูููู ูู data["user_role"]
โ   โโโ user_tracking.py     # ุชุชุจุน ุงููุณุชุฎุฏููู
โ   โโโ i18n_middleware.py   # ุญูู ุฎุฏูุฉ ุงููุตูุต
โโโ models/                  # ููุงุฐุฌ ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ   โโโ user.py              # ูููุฐุฌ ุงููุณุชุฎุฏู (User, UserRole)
โ   โโโ text_entry.py        # ูููุฐุฌ ุงููุตูุต ุงูุฏููุงููููุฉ
โ   โโโ setting.py           # ูููุฐุฌ ุงูุฅุนุฏุงุฏุงุช
โ   โโโ audit_log.py         # ูููุฐุฌ ุณุฌู ุงูุฅุฌุฑุงุกุงุช (AuditLog)
โ   โโโ section.py           # ูููุฐุฌ ุงููุณู (Section)
โ   โโโ file.py              # ูููุฐุฌ ุงูููู (File, FileType, FileStatus)
โ   โโโ file_section.py      # ุฌุฏูู ุงูุฑุจุท ููู-ูุณู (many-to-many)
โโโ modules/                 # ูุญุฏุงุช ุงูุจูุช
โ   โโโ central_router.py    # ุงูุชูุฌูู ุงููุฑูุฒู ููุฃุฒุฑุงุฑ
โ   โโโ error_handler.py     # ูุนุงูุฌ ุงูุฃุฎุทุงุก ุงูุนุงู
โ   โโโ health_check.py      # ูุญุต ุฌุงูุฒูุฉ ุงููุธุงู
โ   โโโ login_logger.py      # ุชุณุฌูู ุฏุฎูู ุงููุณุชุฎุฏููู
โโโ services/                # ุทุจูุฉ ุงูุฎุฏูุงุช
โ   โโโ i18n.py              # ุฎุฏูุฉ ุงููุตูุต ุงูุฏููุงููููุฉ
โ   โโโ state.py             # ุฅุฏุงุฑุฉ ุงูุญุงูุงุช
โ   โโโ user.py              # ุฎุฏูุฉ ุงููุณุชุฎุฏููู
โ   โโโ seeder.py            # ุฒุฑุงุนุฉ ุงููุตูุต ุงูุงูุชุฑุงุถูุฉ
โ   โโโ permissions.py       # ูุธุงู ุงูุตูุงุญูุงุช ุงููุฑูุฒู (Permission, ROLE_PERMISSIONS)
โ   โโโ audit.py             # ุฎุฏูุฉ ุณุฌู ุงูุฅุฌุฑุงุกุงุช
โ   โโโ sections.py          # ุฎุฏูุฉ ุงูุฃูุณุงู (CRUD + ุชุฑุชูุจ + ุชุฏุงุฎู)
โ   โโโ files.py             # ุฎุฏูุฉ ุงููููุงุช (CRUD + ุฑุจุท ุจุงูุฃูุณุงู + ูุดู ุงูุชูุฑุงุฑ)
โโโ utils/                   # ุฃุฏูุงุช ูุณุงุนุฏุฉ
โโโ migrations/              # ูุฌุฑุงุช Alembic
โ   โโโ env.py
โ   โโโ script.py.mako
โ   โโโ versions/            # ูููุงุช ุงููุฌุฑุงุช
โโโ main.py                  # ููุทุฉ ุงูุชุดุบูู
```

## ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
| ุงููุชุบูุฑ | ุงููุตู |
|---------|-------|
| `BOT_TOKEN` | ุชููู ุงูุจูุช ูู BotFather |
| `DATABASE_URL` | ุฑุงุจุท ุงุชุตุงู PostgreSQL |
| `DEBUG` | ูุถุน ุงูุชุตุญูุญ (true/false) |
| `LOG_CHANNEL_ID` | ูุนุฑู ููุงุฉ ุงููุฑุงูุจุฉ (0 = ูุนุทู) |
| `SUBSCRIPTION_ENABLED` | ุชูุนูู ุงูุงุดุชุฑุงู ุงูุฅุฌุจุงุฑู (true/false) |
| `SUBSCRIPTION_CHANNEL_IDS` | ูุนุฑูุงุช ุงููููุงุช ุงููุทููุจุฉ (ููุตููุฉ ุจููุงุตู) |
| `STATE_TIMEOUT_SECONDS` | ูููุฉ ุงูุชูุงุก ุงูุญุงูุฉ ุจุงูุซูุงูู (ุงูุชุฑุงุถู: 300) |
| `STORAGE_CHANNEL_ID` | ูุนุฑู ููุงุฉ ุงูุชุฎุฒูู ูููููุงุช (0 = ูุนุทู) |
| `DEFAULT_LANGUAGE` | ุงููุบุฉ ุงูุงูุชุฑุงุถูุฉ (ุงูุชุฑุงุถู: ar) |

## ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
| ุงูุฌุฏูู | ุงููุตู |
|--------|-------|
| `users` | ุจูุงูุงุช ุงููุณุชุฎุฏููู ูุงูุฃุฏูุงุฑ ูุงูุญุธุฑ |
| `text_entries` | ุงููุตูุต ุงูุฏููุงููููุฉ (I18n) |
| `settings` | ุฅุนุฏุงุฏุงุช ุงููุธุงู |
| `audit_logs` | ุณุฌู ุงูุฅุฌุฑุงุกุงุช ุงูุฅุฏุงุฑูุฉ (ููุ ูุงุฐุงุ ูุชู) |
| `sections` | ุงูุฃูุณุงู ุงููุชุฏุงุฎูุฉ (ุงุณูุ ูุตูุ parent_idุ ุชุฑุชูุจุ ุญุงูุฉ) |
| `files` | ุงููููุงุช (file_id, file_unique_id, name, type, size, status, uploaded_by) |
| `file_sections` | ุฑุจุท ุงููููุงุช ุจุงูุฃูุณุงู (many-to-many) |

## ูุธุงู ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช
| ุงูุฏูุฑ | ุงูุตูุงุญูุงุช |
|-------|-----------|
| `user` | ุชุตูุญ ุงููุงุฌูุฉ ููุท (browse) |
| `moderator` | ุชุตูุญ + ุฑูุน ูููุงุช (browse, upload_file) |
| `admin` | ุชุญูู ูุงูู (browse, upload_file, manage_sections, manage_files, manage_users, manage_settings, view_audit_log, view_admin_panel) |

### ุขููุฉ ูุญุต ุงูุตูุงุญูุงุช
- `permissions.py` ูุญุชูู ุนูู `Permission` (ุซูุงุจุช ุงูุตูุงุญูุงุช) ู`ROLE_PERMISSIONS` (ุฑุจุท ุงูุฃุฏูุงุฑ ุจุงูุตูุงุญูุงุช)
- `has_permission(role, permission)` ูููุญุต ุงูุจุฑูุฌู
- `check_permission_and_notify(callback, role, permission)` ูููุญุต ูุน ุฅุฑุณุงู ุฑุณุงูุฉ ุฑูุถ
- ุงูุฃุฒุฑุงุฑ ุงูุฅุฏุงุฑูุฉ ุชูุฎูู ุชููุงุฆูุงู ุญุณุจ ุงูุฏูุฑ ูู `build_home_keyboard(role)`

### ุณุฌู ุงูุฅุฌุฑุงุกุงุช (Audit Log)
- `AuditActions` ูู `constants.py` ูุญุชูู ุนูู ุฃููุงุน ุงูุฅุฌุฑุงุกุงุช
- `audit_service.log_action(session, user_id, action, details)` ูุชุณุฌูู ุฃู ุฅุฌุฑุงุก
- ููุณุชุฎุฏู ูุนููุงู ูู ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ูุงููููุงุช (ุฅูุดุงุกุ ุชุนุฏููุ ุญุฐู)

## ูุญุฏุฉ ุงูุฃูุณุงู (ุงููุฑุญูุฉ 4)

### ูููุฐุฌ ุงูุจูุงูุงุช
- `Section`: id, name, description, parent_id (FK ุฐุงุชู), order, is_active, created_at
- ุงูุชุฏุงุฎู ุนุจุฑ parent_id (ุฃูุณุงู ุฑุฆูุณูุฉ โ ุฃูุณุงู ูุฑุนูุฉ)
- ุงูุญุฐู ููุทูู (is_active = False)

### ุจุงุฏุฆุงุช ุงูุฃุฒุฑุงุฑ (Callback Prefixes)
| ุงูุจุงุฏุฆุฉ | ุงูุงุณุชุฎุฏุงู |
|---------|-----------|
| `sec:{id}` | ุนุฑุถ ูุณู (ุชููู ุงููุณุชุฎุฏู) |
| `sec_back:{id}` | ุฑุฌูุน ูููุณู ุงูุฃุจ (0 = ุงูุฌุฐุฑ) |
| `sec_add:{parent_id}` | ุฅุถุงูุฉ ูุณู (ุฃุฏูู) |
| `sec_edit:{id}` | ุชุนุฏูู ุงุณู ูุณู (ุฃุฏูู) |
| `sec_ord:{id}` | ุชุนุฏูู ุชุฑุชูุจ ูุณู (ุฃุฏูู) |
| `sec_del:{id}` | ุญุฐู ูุณู (ุฃุฏูู) |
| `sec_cdel:{id}` | ุชุฃููุฏ ุญุฐู ูุณู (ุฃุฏูู) |
| `sec_cancel` | ุฅูุบุงุก ุงูุนูููุฉ ุงูุฅุฏุงุฑูุฉ |
| `sec_skip_desc` | ุชุฎุทู ุงููุตู ุนูุฏ ุงูุฅุถุงูุฉ |

### ุญุงูุงุช FSM ููุฃุฏูู
| ุงูุญุงูุฉ | ุงููุตู |
|--------|-------|
| `section_add_name` | ุงูุชุธุงุฑ ุงุณู ุงููุณู ุงูุฌุฏูุฏ |
| `section_add_desc` | ุงูุชุธุงุฑ ูุตู ุงููุณู (ุงุฎุชูุงุฑู) |
| `section_edit_name` | ุงูุชุธุงุฑ ุงูุงุณู ุงูุฌุฏูุฏ |
| `section_edit_order` | ุงูุชุธุงุฑ ุฑูู ุงูุชุฑุชูุจ ุงูุฌุฏูุฏ |

### ุชุฏูู ุฅูุดุงุก ูุณู
1. ุฃุฏูู ูุถุบุท "ุฅุถุงูุฉ ูุณู" โ state = section_add_name
2. ููุชุจ ุงูุงุณู โ state = section_add_desc
3. ููุชุจ ุงููุตู ุฃู ูุถุบุท "ุชุฎุทู" โ ูููุดุฃ ุงููุณู + audit log

## ูุญุฏุฉ ุงููููุงุช (ุงููุฑุญูุฉ 5)

### ูููุฐุฌ ุงูุจูุงูุงุช
- `File`: id, file_id (telegram), file_unique_id, name, file_type (enum), file_size, status (enum), uploaded_by, is_active, created_at
- `FileSection`: file_id + section_id (ุฌุฏูู ุฑุจุท many-to-many)
- `FileType`: DOCUMENT, PHOTO, VIDEO, AUDIO, VOICE, VIDEO_NOTE, ANIMATION, STICKER
- `FileStatus`: PENDING, PUBLISHED
- ูุดู ุงูุชูุฑุงุฑ ุนุจุฑ file_unique_id
- ุงูุญุฐู ููุทูู (is_active = False)

### ุจุงุฏุฆุงุช ุงูุฃุฒุฑุงุฑ (Callback Prefixes)
| ุงูุจุงุฏุฆุฉ | ุงูุงุณุชุฎุฏุงู |
|---------|-----------|
| `file:{id}` | ุนุฑุถ/ุฅุฑุณุงู ููู |
| `fpage:{section_id}:{page}` | ุชุตูุญ ุตูุญุงุช ุงููููุงุช |
| `f_up:{section_id}` | ุจุฏุก ุฑูุน ูููุงุช |
| `f_del:{id}` | ุญุฐู ููู |
| `f_cdel:{id}` | ุชุฃููุฏ ุญุฐู ููู |
| `f_done` | ุฅููุงุก ุฌูุณุฉ ุงูุฑูุน |
| `f_cancel` | ุฅูุบุงุก ุฌูุณุฉ ุงูุฑูุน |

### ุญุงูุฉ FSM ููุฑูุน
| ุงูุญุงูุฉ | ุงููุตู |
|--------|-------|
| `file_upload` | ุงูุชุธุงุฑ ูููุงุช ูู ุงููุณุชุฎุฏู (section_id, uploaded_count ูู state_data) |

### ุชุฏูู ุฑูุน ุงููููุงุช
1. ูุดุฑู/ุฃุฏูู ูุถุบุท "ุฑูุน ูููุงุช" ูู ูุณู โ state = file_upload
2. ูุฑุณู ูููุงุช (ูุงุญุฏ ุฃู ุนุฏุฉ) โ ูู ููู ููุญูุธ ูููุฑุจุท ุจุงููุณู
3. ูุถุบุท "ุงูุชููุช" ุฃู "ุฅูุบุงุก" โ ููุฎุต ุฃู ุฅูุบุงุก
4. ุงููููุงุช ุชูุญูู ูููุงุฉ ุงูุชุฎุฒูู (STORAGE_CHANNEL_ID) ูfile_id ููุญูุธ
5. ูุดู ุงูุชูุฑุงุฑ: ุฅุฐุง ููุฌุฏ ููู ุจููุณ file_unique_id ููุฑุจุท ุจุงููุณู ุงูุญุงูู ุจุฏูุงู ูู ุฅุนุงุฏุฉ ุงูุฑูุน

### Deep Linking
- ุฑุงุจุท ูุจุงุดุฑ ููููู: `t.me/bot?start=file_<id>`
- ููุนุงูุฌ ูู /start handler ููุฑุณู ุงูููู ูุจุงุดุฑุฉ ูููุณุชุฎุฏู

### ุงูุชุตูุญ ุงููููุณูู (Pagination)
- 5 ูููุงุช ููู ุตูุญุฉ
- ุฃุฒุฑุงุฑ ุงูุชููู (ุงูุณุงุจู/ุงูุชุงูู) ูุน ุฑูู ุงูุตูุญุฉ
- ุฃุฒุฑุงุฑ ุฅุฏุงุฑูุฉ (ุฑูุน/ุญุฐู) ุชุธูุฑ ุญุณุจ ุงูุตูุงุญูุงุช

## ุฃูุงูุฑ Alembic
```bash
alembic current          # ุนุฑุถ ุงูุญุงูุฉ ุงูุญุงููุฉ
alembic upgrade head     # ุชุทุจูู ุฌููุน ุงููุฌุฑุงุช
alembic revision -m "x"  # ุฅูุดุงุก ูุฌุฑุฉ ุฌุฏูุฏุฉ
alembic downgrade -1     # ุงูุชุฑุงุฌุน ุนู ุขุฎุฑ ูุฌุฑุฉ
```

## ุชุดุบูู ุงูุจูุช
```bash
python -m bot.main
```

## ุงูุจููุฉ ุงููุนูุงุฑูุฉ
- **ุงููุตูุต**: ุฌููุน ุงููุตูุต ุงูููุฌูุฉ ูููุณุชุฎุฏู ูู ุฌุฏูู `text_entries` ุนุจุฑ I18nService
- **ุงููุตูุต ุงูุฏุงุฎููุฉ**: ุฌููุน ุฑุณุงุฆู ุงูู logging ูุงูุฃุฎุทุงุก ูู `constants.py`
- **ุงููุณุทุงุก**: ููููุฐูู ุจุงูุชุฑุชูุจ: ุญุธุฑ โ ุงุดุชุฑุงู โ ุชุชุจุน โ ุฏูุฑ โ I18n
- **CallbackPrefixes**: ุฌููุน ุจุงุฏุฆุงุช ุงูุฃุฒุฑุงุฑ ูู `constants.py`
- **ุงูุญุงูุงุช**: ุญุงูุฉ ูุงุญุฏุฉ ููู ูุณุชุฎุฏู ูุน ูููุฉ ุฒูููุฉ ูุงุจูุฉ ููุชูููู
- **ุงูุชูุฌูู ุงููุฑูุฒู**: ุฌููุน callbacks ุชูุฑ ุนุจุฑ CentralRouter
- **ุงูุตูุงุญูุงุช**: ูุญุต ูุฑูุฒู ุนุจุฑ `permissions.py` ูุจู ุฃู ุฅุฌุฑุงุก ุฅุฏุงุฑู
- **ุณุฌู ุงูุฅุฌุฑุงุกุงุช**: ุชุณุฌูู ูู ุฅุฌุฑุงุก ุฅุฏุงุฑู ูู `audit_logs`
- **ุชุฑุชูุจ ุงูุฑุงูุชุฑุงุช**: home โ files โ sections โ central โ fallback (files ูุจู sections ูุงูุชูุงุท ุฑุณุงุฆู FSM)

## ููุญุฉ ุงูุชุญูู ุงูุฅุฏุงุฑูุฉ

### ุจุงุฏุฆุงุช ุงูุฃุฒุฑุงุฑ
| ุงูุจุงุฏุฆุฉ | ุงูุงุณุชุฎุฏุงู |
|---------|-----------|
| `admin_panel` | ุนุฑุถ ููุญุฉ ุงูุชุญูู |
| `adm_sec` | ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ูู ููุญุฉ ุงูุชุญูู |

### ุชุฏูู ููุญุฉ ุงูุชุญูู
1. ุฃุฏูู ูุถุบุท "ููุญุฉ ุงูุชุญูู" โ ุชุธูุฑ ุฃุฒุฑุงุฑ ุงูุฅุฏุงุฑุฉ
2. ูุถุบุท "ุฅุฏุงุฑุฉ ุงูุฃูุณุงู" โ ููุชูู ูุนุฑุถ ุงูุฃูุณุงู ุจุตูุงุญูุงุช ุงูุฃุฏูู
3. ูุถุบุท "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ" โ ูุนูุฏ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ

### ุชุญุณููุงุช UI/UX
- ุฌููุน ุงูุฃุฒุฑุงุฑ ุชุญุชูู ุนูู ุฅูููุฌู ููุงุณุจ (๐ ููุฃูุณุงูุ ๐ ูููููุงุชุ โ ููุชุฃููุฏุ โ๏ธ ููุชุญุฐูุฑ)
- ูููุงุช ุชูุนุฑุถ ุจุฅูููุฌู ุญุณุจ ุงูููุน (๐ ูุณุชูุฏุ ๐ผ ุตูุฑุฉุ ๐ฌ ููุฏููุ ๐ต ุตูุช)
- ุฑุณุงุฆู ุงูุชุฃููุฏ ูุงูุญุฐู ุชุชุถูู ุชุญุฐูุฑุงู ูุงุถุญุงู
- ูุตูุต ุงูุนูุงููู ุจุชูุณูู HTML bold

## ุงููุฑุงุญู ุงูููุชููุฉ
- [x] ุงููุฑุญูุฉ 0: ุงูุชููุฆุฉ
- [x] ุงููุฑุญูุฉ 1: ุงูููุงุฉ + ุงููุตูุต ุงูุฏููุงููููุฉ
- [x] ุงููุฑุญูุฉ 2: ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฑุฆูุณูุฉ
- [x] ุงููุฑุญูุฉ 3: ูุญุฏุฉ ุงูุตูุงุญูุงุช
- [x] ุงููุฑุญูุฉ 4: ูุญุฏุฉ ุงูุฃูุณุงู
- [x] ุงููุฑุญูุฉ 5: ูุญุฏุฉ ุงููููุงุช
- [x] ููุญุฉ ุงูุชุญูู: ุฑุจุท ุจุงูุฃูุณุงู + ุชุญุณููุงุช UI/UX

## ุงููุฑุงุญู ุงููุงุฏูุฉ
- [ ] ุงููุฑุญูุฉ 6: ุงูุจุญุซ
- [ ] ุงููุฑุญูุฉ 7: ููุญุฉ ุงูุฃุฏูู (ุชูุณุนุฉ)
- [ ] ุงููุฑุญูุฉ 8: ูุญุฏุฉ ุงููุณุงููุงุช
- [ ] ุงููุฑุญูุฉ 9: ุงูููุงู ุงูุซูููุฉ
- [ ] ุงููุฑุญูุฉ 10: ุงููุณุงุนุฏ ุงูุฐูู
